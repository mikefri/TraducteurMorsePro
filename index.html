<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA - Rendre l'App Installable</title>
    <!-- 1. Lien vers le Manifest PWA -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- 2. Configuration des couleurs pour le thème mobile -->
    <meta name="theme-color" content="#4f46e5">

    <!-- Chargement de Tailwind CSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Définition de la police Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Style pour simuler l'installation */
        .install-button {
            display: none; /* Masqué par défaut, affiché par le JS si l'installation est possible */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg text-gray-800 border-t-4 border-indigo-600">
        <h1 class="text-3xl font-bold mb-4 text-indigo-600">Application PWA Démo</h1>
        <p class="mb-6 text-gray-600">
            Ceci est une application web progressive. Grâce au **Service Worker** et au **Manifest**, elle est maintenant installable et fonctionne hors ligne.
        </p>

        <div id="status-message" class="p-3 mb-4 rounded-lg bg-gray-100 border border-gray-300 text-sm">
            Statut du Service Worker : En attente d'enregistrement...
        </div>

        <button id="installButton" class="install-button w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">
            Installer l'Application
        </button>

        <p class="mt-4 text-xs text-gray-500 text-center">
            (Le bouton d'installation apparaîtra lorsque le navigateur le permettra.)
        </p>
    </div>

    <script>
        // Configuration PWA et Service Worker
        
        let deferredPrompt;
        const installButton = document.getElementById('installButton');
        const statusMessage = document.getElementById('status-message');
        const serviceWorkerPath = '/service-worker.js';

        // 3. Enregistrement du Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(serviceWorkerPath, { scope: '/' })
                    .then((registration) => {
                        console.log('Service Worker enregistré avec succès. Scope:', registration.scope);
                        statusMessage.textContent = 'Statut du Service Worker : Enregistré et opérationnel (hors ligne activé)';
                        statusMessage.classList.remove('bg-gray-100');
                        statusMessage.classList.add('bg-green-100', 'text-green-800');
                    })
                    .catch((error) => {
                        console.error('Échec de l\'enregistrement du Service Worker:', error);
                        statusMessage.textContent = 'Statut du Service Worker : Erreur lors de l\'enregistrement';
                        statusMessage.classList.remove('bg-gray-100');
                        statusMessage.classList.add('bg-red-100', 'text-red-800');
                    });
            });
        } else {
             statusMessage.textContent = 'Statut du Service Worker : Non supporté par ce navigateur.';
             statusMessage.classList.remove('bg-gray-100');
             statusMessage.classList.add('bg-orange-100', 'text-orange-800');
        }

        // Gestion de l'événement d'installation ('beforeinstallprompt')
        window.addEventListener('beforeinstallprompt', (e) => {
            // Empêche le navigateur de montrer sa propre invite d'installation
            e.preventDefault();
            // Stocke l'événement pour pouvoir le déclencher plus tard
            deferredPrompt = e;
            // Affiche le bouton d'installation personnalisé
            installButton.style.display = 'block';
            installButton.classList.remove('install-button'); 
        });

        // Gestion du clic sur le bouton d'installation
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                // Masque le bouton pendant la tentative d'installation
                installButton.style.display = 'none';
                
                // Déclenche l'invite d'installation du navigateur
                deferredPrompt.prompt();
                
                // Attend que l'utilisateur réponde à l'invite
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('L\'utilisateur a accepté l\'installation.');
                    statusMessage.textContent = 'Application installée avec succès !';
                } else {
                    console.log('L\'utilisateur a refusé l\'installation.');
                    statusMessage.textContent = 'L\'installation a été annulée.';
                    // Laisse le bouton affiché si l'utilisateur annule
                    installButton.style.display = 'block';
                }
                
                // Réinitialise deferredPrompt
                deferredPrompt = null;
            }
        });
    </script>
</body>
</html>
